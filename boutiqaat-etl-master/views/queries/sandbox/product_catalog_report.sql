CREATE OR REPLACE VIEW sandbox.product_catalog_report AS
SELECT magento.parent_sku AS config_sku, pg_catalog.listagg(DISTINCT (nav.supplier_item_no)::text) AS supplier_item_no, pg_catalog.listagg(DISTINCT (nav.brand)::text) AS brand, pg_catalog.listagg(DISTINCT (magento.category1)::text) AS category1, pg_catalog.listagg(DISTINCT (magento.category2)::text) AS category2, pg_catalog.listagg(DISTINCT (magento.category3)::text) AS category3, pg_catalog.listagg(DISTINCT (magento.category4)::text) AS category4, pg_catalog.listagg(DISTINCT (magento.color)::text) AS color, pg_catalog.listagg(DISTINCT (magento.p)::text) AS price, sum(aoi.sold_qtys) AS solt_qty, sum(nav.total_sellable_qty) AS total_sellable_qty, sum(nav.toal_nav_non_sellable) AS total_non_sellable_qty, sum(nav.soh) AS soh, CASE WHEN (COALESCE(((sum(aoi.sold_qtys))::numeric + sum(nav.soh)), (0)::numeric) <> (0)::numeric) THEN round(((sum(aoi.sold_qtys))::numeric / ((sum(aoi.sold_qtys))::numeric + sum(nav.soh))), 3) ELSE (0)::numeric END AS sell_through, pg_catalog.listagg(DISTINCT (magento.image)::text) AS image, COALESCE((pg_catalog.listagg(DISTINCT (nav.stock_refreshed_datetime)::text))::timestamp without time zone, (SELECT DISTINCT nav_product_category.stock_refreshed_datetime FROM nav.nav_product_category WHERE (nav_product_category.stock_refreshed_datetime IS NOT NULL))) AS stock_refreshed_datetime FROM ((nav.nav_product_category nav LEFT JOIN (SELECT magento_product_catalog.row_id, magento_product_catalog.sku, magento_product_catalog.parent_sku, magento_product_catalog.color, magento_product_catalog.price AS prie, magento_product_catalog.category1, magento_product_catalog.category2, magento_product_catalog.category3, magento_product_catalog.category4, magento_product_catalog.category5, magento_product_catalog.image, round(magento_product_catalog.price, 3) AS p, pg_catalog.dense_rank() OVER(  PARTITION BY magento_product_catalog.parent_sku ORDER BY magento_product_catalog.image) AS rank_no FROM magento.magento_product_catalog) magento ON ((((magento.sku)::text = (nav.sku)::text) AND (magento.rank_no = 1)))) LEFT JOIN (SELECT ofs_sku_sales.sku, sum(ofs_sku_sales.sold_qtys) AS sold_qtys FROM aoi.ofs_sku_sales GROUP BY ofs_sku_sales.sku) aoi ON (((aoi.sku)::text = (nav.sku)::text))) GROUP BY magento.parent_sku ORDER BY magento.parent_sku
WITH NO SCHEMA BINDING;